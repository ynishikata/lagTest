<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>lagTest RAG Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0f172a;
      --bg-alt: #020617;
      --card-bg: #111827;
      --border: #1f2937;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    .app {
      max-width: 1120px;
      width: 100%;
      padding: 24px 16px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.03em;
    }
    header p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
    }
    .badge {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 4px 10px;
      font-size: 11px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(8px);
    }
    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
    }
    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 16px;
    }
    @media (max-width: 860px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(17,24,39,0.98));
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      padding: 16px 16px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 60%);
      pointer-events: none;
      mix-blend-mode: screen;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }
    .card-header-line {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
    }
    .card-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
    }
    label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
      display: block;
    }
    textarea, input[type="number"], input[type="text"] {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      padding: 8px 10px;
      font-size: 13px;
      resize: vertical;
      min-height: 72px;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    textarea:focus, input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
      background: rgba(15,23,42,0.98);
    }
    .row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .row > * {
      flex: 1;
    }
    .row-narrow {
      max-width: 110px;
    }
    .btn {
      border-radius: 999px;
      border: 0;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: radial-gradient(circle at top left, #38bdf8, #0ea5e9);
      color: #0b1120;
      box-shadow: 0 10px 30px rgba(56,189,248,0.5);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
      white-space: nowrap;
    }
    .btn.secondary {
      background: rgba(15,23,42,0.8);
      color: var(--muted);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: none;
    }
    .btn:disabled {
      opacity: 0.65;
      cursor: default;
      box-shadow: none;
    }
    .btn:not(:disabled):hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 14px 35px rgba(56,189,248,0.6);
    }
    .btn.secondary:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15,23,42,0.9);
    }
    .btn-icon {
      font-size: 15px;
    }
    .status {
      font-size: 12px;
      color: var(--muted);
      min-height: 16px;
    }
    .status.error {
      color: var(--danger);
    }
    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
    }
    .pill-strong {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: rgba(56,189,248,0.5);
    }
    .answer-box {
      min-height: 100px;
      border-radius: 10px;
      border: 1px dashed rgba(75,85,99,0.8);
      padding: 10px 11px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text);
      background: radial-gradient(circle at top left, rgba(8,47,73,0.8), rgba(15,23,42,0.95));
      white-space: pre-wrap;
    }
    .sources {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      max-height: 130px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 6px 8px;
      background: rgba(15,23,42,0.95);
    }
    .source-item {
      margin-bottom: 6px;
      padding-bottom: 5px;
      border-bottom: 1px dashed rgba(55,65,81,0.7);
      white-space: pre-wrap;
    }
    .source-item:last-child {
      border-bottom: none;
      margin-bottom: 2px;
      padding-bottom: 0;
    }
    .logs-box {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      max-height: 180px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid rgba(55,65,81,0.9);
      padding: 6px 8px;
      background: rgba(15,23,42,0.95);
      white-space: pre-wrap;
    }
    .log-item {
      margin-bottom: 6px;
      padding-bottom: 5px;
      border-bottom: 1px dashed rgba(55,65,81,0.7);
    }
    .log-item:last-child {
      border-bottom: none;
      margin-bottom: 2px;
      padding-bottom: 0;
    }
    footer {
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }
    footer a {
      color: var(--accent);
      text-decoration: none;
      opacity: 0.9;
    }
    footer a:hover {
      text-decoration: underline;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>lagTest RAG Demo</h1>
        <p>ä»»æ„ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¾ã›ã¦ã€ãã®å†…å®¹ã«åŸºã¥ã„ã¦è³ªå•ã§ãã‚‹ç°¡æ˜“RAG UIã§ã™ã€‚</p>
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span>Local Â· http://localhost:8080</span>
      </div>
    </header>

    <main>
      <!-- Document ingest -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">1. æ–‡æ›¸ã‚’èª­ã¿è¾¼ã‚€</div>
            <div class="card-subtitle">é•·ã‚ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ»ä»•æ§˜æ›¸ãƒ»ãƒ–ãƒ­ã‚°è¨˜äº‹ãªã©ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</div>
          </div>
          <span class="pill">/documents</span>
        </div>

        <div>
          <label for="docText">æ–‡æ›¸æœ¬æ–‡</label>
          <textarea id="docText" placeholder="ä¾‹: ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯â—¯â—¯ã‚’ç›®çš„ã¨ã—ã¦è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€ä¸»è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯..."></textarea>
        </div>

        <div class="row" style="margin-top: 4px;">
          <button id="ingestBtn" class="btn">
            <span class="btn-icon">â¬†ï¸</span>
            <span>æ–‡æ›¸ã‚’ç™»éŒ²ã™ã‚‹</span>
          </button>
          <button id="clearDocBtn" class="btn secondary">
            ã‚¯ãƒªã‚¢
          </button>
        </div>
        <div id="ingestStatus" class="status"></div>
      </section>

      <!-- Query -->
      <section class="card">
        <div class="card-header">
          <div class="card-header-line">
            <div class="card-title">2. è³ªå•ã™ã‚‹</div>
            <div class="card-subtitle">ç™»éŒ²æ¸ˆã¿ã®æ–‡æ›¸ã®å†…å®¹ã ã‘ã‚’æ ¹æ‹ ã«ã€OpenAIã«å›ç­”ã•ã›ã¾ã™ã€‚</div>
          </div>
          <span class="pill pill-strong">/query</span>
        </div>

        <div>
          <label for="question">è³ªå•</label>
          <textarea id="question" placeholder="ä¾‹: ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã®å…¨ä½“æ§‹æˆã¨ä¸»è¦ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚"></textarea>
        </div>

        <div class="row">
          <div class="row row-narrow">
            <div>
              <label for="topK">top_k</label>
              <input id="topK" type="number" min="1" max="10" value="3" />
            </div>
          </div>
          <div>
            <label for="systemPrompt">system promptï¼ˆä»»æ„ï¼‰</label>
            <input id="systemPrompt" type="text" placeholder="æœªæŒ‡å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ¶ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚" />
          </div>
        </div>

        <div class="row" style="margin-top: 4px;">
          <button id="askBtn" class="btn">
            <span class="btn-icon">ğŸ’¬</span>
            <span>è³ªå•ã™ã‚‹</span>
          </button>
          <button id="clearAnswerBtn" class="btn secondary">
            çµæœã‚’ã‚¯ãƒªã‚¢
          </button>
        </div>
        <div id="queryStatus" class="status"></div>

        <div>
          <label>å›ç­”</label>
          <div id="answerBox" class="answer-box"></div>
        </div>
        <div>
          <label>ä½¿ç”¨ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆsourcesï¼‰</label>
          <div id="sourcesBox" class="sources"></div>
        </div>
      </section>
    </main>

    <main style="margin-top: 8px;">
      <!-- Virtual meeting -->
      <section class="card">
        <div class="card-header">
          <div class="card-header-line">
            <div class="card-title">3. ä»®æƒ³ä¼šè­°ï¼ˆãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰</div>
            <div class="card-subtitle">æ…é‡æ´¾ãƒ»æ”»ã‚æ´¾ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ãƒ»ç¾å ´ã®4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦è‡ªå‹•è­°è«–ã—ã€çµè«–ã‚’ã¾ã¨ã‚ã¾ã™ã€‚</div>
          </div>
          <span class="pill pill-strong">/meeting</span>
        </div>

        <div>
          <label for="meetingTopic">ä¼šè­°ãƒˆãƒ”ãƒƒã‚¯</label>
          <textarea id="meetingTopic" placeholder="ä¾‹: ç¤¾å†…ã«æ–°ã—ã„AIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’å°å…¥ã™ã‚‹éš›ã®é€²ã‚æ–¹ã«ã¤ã„ã¦è­°è«–ã—ã¦ãã ã•ã„ã€‚"></textarea>
        </div>

        <div class="row">
          <div class="row row-narrow">
            <div>
              <label for="meetingRounds">ãƒ©ã‚¦ãƒ³ãƒ‰æ•°</label>
              <input id="meetingRounds" type="number" min="1" max="10" value="5" />
            </div>
          </div>
          <div class="status" id="meetingStatus"></div>
        </div>

        <div class="row" style="margin-top: 4px;">
          <button id="meetingBtn" class="btn">
            <span class="btn-icon">ğŸ§ </span>
            <span>ä»®æƒ³ä¼šè­°ã‚’é–‹å§‹</span>
          </button>
          <button id="meetingStreamBtn" class="btn secondary">
            ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œ
          </button>
          <button id="clearMeetingBtn" class="btn secondary">
            çµæœã‚’ã‚¯ãƒªã‚¢
          </button>
        </div>

        <div style="margin-top: 4px;">
          <label>ä¼šè­°ã‚µãƒãƒª</label>
          <div id="meetingSummary" class="answer-box"></div>
        </div>
        <div>
          <label>ä¼šè­°ãƒ­ã‚°</label>
          <div id="meetingLogs" class="logs-box"></div>
        </div>
      </section>
    </main>

    <footer>
      <span>â€» ãƒ‡ãƒ¼ã‚¿ã¯ãƒ—ãƒ­ã‚»ã‚¹å†…ãƒ¡ãƒ¢ãƒªã®ã¿ã§ç®¡ç†ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</span>
      <span>Powered by OpenAI RAG prototype</span>
    </footer>
  </div>

  <script>
    const ingestBtn = document.getElementById("ingestBtn");
    const clearDocBtn = document.getElementById("clearDocBtn");
    const docText = document.getElementById("docText");
    const ingestStatus = document.getElementById("ingestStatus");

    const askBtn = document.getElementById("askBtn");
    const clearAnswerBtn = document.getElementById("clearAnswerBtn");
    const question = document.getElementById("question");
    const topK = document.getElementById("topK");
    const systemPrompt = document.getElementById("systemPrompt");
    const queryStatus = document.getElementById("queryStatus");
    const answerBox = document.getElementById("answerBox");
    const sourcesBox = document.getElementById("sourcesBox");

    const meetingTopic = document.getElementById("meetingTopic");
    const meetingRounds = document.getElementById("meetingRounds");
    const meetingStatus = document.getElementById("meetingStatus");
    const meetingBtn = document.getElementById("meetingBtn");
    const meetingStreamBtn = document.getElementById("meetingStreamBtn");
    const clearMeetingBtn = document.getElementById("clearMeetingBtn");
    const meetingSummary = document.getElementById("meetingSummary");
    const meetingLogs = document.getElementById("meetingLogs");

    let meetingEventSource = null;

    function setIngestStatus(msg, isError = false) {
      ingestStatus.textContent = msg || "";
      ingestStatus.classList.toggle("error", !!isError);
    }
    function setQueryStatus(msg, isError = false) {
      queryStatus.textContent = msg || "";
      queryStatus.classList.toggle("error", !!isError);
    }
    function setMeetingStatus(msg, isError = false) {
      meetingStatus.textContent = msg || "";
      meetingStatus.classList.toggle("error", !!isError);
    }

    ingestBtn.addEventListener("click", async () => {
      const content = docText.value.trim();
      if (!content) {
        setIngestStatus("æ–‡æ›¸æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }
      ingestBtn.disabled = true;
      setIngestStatus("ç™»éŒ²ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚");
      try {
        const res = await fetch("/documents", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content }),
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        const data = await res.json();
        setIngestStatus(`ç™»éŒ²å®Œäº†: document_id = ${data.document_id}`);
      } catch (err) {
        console.error(err);
        setIngestStatus("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.message || err), true);
      } finally {
        ingestBtn.disabled = false;
      }
    });

    clearDocBtn.addEventListener("click", () => {
      docText.value = "";
      setIngestStatus("");
    });

    askBtn.addEventListener("click", async () => {
      const q = question.value.trim();
      if (!q) {
        setQueryStatus("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }
      let k = parseInt(topK.value || "3", 10);
      if (isNaN(k) || k < 1) k = 3;

      const payload = { query: q, top_k: k };
      const sp = systemPrompt.value.trim();
      if (sp) payload.system_prompt = sp;

      askBtn.disabled = true;
      setQueryStatus("å›ç­”ç”Ÿæˆä¸­... OpenAIã«å•ã„åˆã‚ã›ã¦ã„ã¾ã™ã€‚");
      answerBox.textContent = "";
      sourcesBox.innerHTML = "";

      try {
        const res = await fetch("/query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        const data = await res.json();
        answerBox.textContent = data.answer || "(å›ç­”ãŒç©ºã§ã—ãŸ)";

        if (Array.isArray(data.sources) && data.sources.length > 0) {
          sourcesBox.innerHTML = "";
          data.sources.forEach((s, idx) => {
            const div = document.createElement("div");
            div.className = "source-item";
            div.textContent = `#${idx + 1}\n` + s;
            sourcesBox.appendChild(div);
          });
        } else {
          sourcesBox.textContent = "(ä½¿ç”¨ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯è¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ)";
        }
        setQueryStatus("å›ç­”å–å¾—å®Œäº†ã€‚");
      } catch (err) {
        console.error(err);
        setQueryStatus("ã‚¯ã‚¨ãƒªã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.message || err), true);
      } finally {
        askBtn.disabled = false;
      }
    });

    clearAnswerBtn.addEventListener("click", () => {
      answerBox.textContent = "";
      sourcesBox.innerHTML = "";
      setQueryStatus("");
    });

    meetingBtn.addEventListener("click", async () => {
      const topic = meetingTopic.value.trim();
      if (!topic) {
        setMeetingStatus("ä¼šè­°ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }

      let rounds = parseInt(meetingRounds.value || "5", 10);
      if (isNaN(rounds) || rounds < 1) rounds = 5;

      const payload = { topic, max_rounds: rounds };

      meetingBtn.disabled = true;
      setMeetingStatus("ä¼šè­°é€²è¡Œä¸­... è¤‡æ•°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§è­°è«–ã—ã¦ã„ã¾ã™ã€‚");
      meetingSummary.textContent = "";
      meetingLogs.innerHTML = "";

      try {
        const res = await fetch("/meeting", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        const data = await res.json();
        meetingSummary.textContent = data.summary || "(ã‚µãƒãƒªãŒç©ºã§ã—ãŸ)";

        if (Array.isArray(data.logs) && data.logs.length > 0) {
          meetingLogs.innerHTML = "";
          data.logs.forEach((log) => {
            const div = document.createElement("div");
            div.className = "log-item";
            const roundLabel = typeof log.round === "number" ? `Round ${log.round}` : "";
            const header = `[${roundLabel} ${log.speaker || "Unknown"}]`.trim();
            const content = log.content || "";
            div.textContent = `${header}\n${content}`;
            meetingLogs.appendChild(div);
          });
        } else {
          meetingLogs.textContent = "(ãƒ­ã‚°ã¯è¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ)";
        }
        setMeetingStatus("ä¼šè­°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
      } catch (err) {
        console.error(err);
        setMeetingStatus("ä¼šè­°ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: " + (err.message || err), true);
      } finally {
        meetingBtn.disabled = false;
      }
    });

    clearMeetingBtn.addEventListener("click", () => {
      meetingSummary.textContent = "";
      meetingLogs.innerHTML = "";
      setMeetingStatus("");
    });

    meetingStreamBtn.addEventListener("click", () => {
      const topic = meetingTopic.value.trim();
      if (!topic) {
        setMeetingStatus("ä¼šè­°ãƒˆãƒ”ãƒƒã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", true);
        return;
      }

      let rounds = parseInt(meetingRounds.value || "5", 10);
      if (isNaN(rounds) || rounds < 1) rounds = 5;

      if (meetingEventSource) {
        meetingEventSource.close();
        meetingEventSource = null;
      }

      meetingSummary.textContent = "";
      meetingLogs.innerHTML = "";
      setMeetingStatus("ä¼šè­°é€²è¡Œä¸­ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰... è¤‡æ•°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§è­°è«–ã—ã¦ã„ã¾ã™ã€‚");

      const params = new URLSearchParams();
      params.set("topic", topic);
      params.set("max_rounds", String(rounds));

      const es = new EventSource(`/meeting/stream?${params.toString()}`);
      meetingEventSource = es;

      es.addEventListener("log", (event) => {
        try {
          const data = JSON.parse(event.data);
          if (!data.log) return;
          const log = data.log;
          const div = document.createElement("div");
          div.className = "log-item";
          const roundLabel = typeof log.round === "number" ? `Round ${log.round}` : "";
          const header = `[${roundLabel} ${log.speaker || "Unknown"}]`.trim();
          const content = log.content || "";
          div.textContent = `${header}\n${content}`;
          meetingLogs.appendChild(div);
          meetingLogs.scrollTop = meetingLogs.scrollHeight;
        } catch (e) {
          console.error("failed to parse log event", e);
        }
      });

      es.addEventListener("summary", (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.summary) {
            meetingSummary.textContent = data.summary;
          }
          setMeetingStatus("ä¼šè­°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰");
        } catch (e) {
          console.error("failed to parse summary event", e);
        } finally {
          es.close();
          meetingEventSource = null;
        }
      });

      es.onerror = (err) => {
        console.error("meeting stream error", err);
        setMeetingStatus("ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚", true);
        es.close();
        meetingEventSource = null;
      };
    });
  </script>
</body>
</html>


